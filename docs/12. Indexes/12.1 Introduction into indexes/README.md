# Введение в индексы

**Индекс** - это структура данных, ускоряющая выборку данных из таблицы за счёт доп. операций
записи и пространства на диске, используемых для хранения структуры данных и
поддержания её в актуальном состоянии.

## Устройство БД

- `database cluster` - одна и более БД, управляемые из под одной инстанции сервера
- Файлы данных кластера лежат в директории `data` (часто называемой `PGDATA`)
- Для каждой БД есть своя подпапка в `PGDATA/base`
- Для каждой таблицы и индекса выделяется отдельный файл

- Таблица состоит из массива страниц (блоков, размером 8кб)
- Файл таблицы называется `Heap File` - содержат списки неупорядоченных записей различной длины

- Рядом с файлом таблицы лежит файл `FSM` (free space map)
- `FSM` не обновляется при каждом обновлении или удалении строк
- `VACUUM [FULL]` - команда для очистки "дохлых" версий строк
  - Не удаляет грубо, а помечает как память, которую можно перезаписать
  - Похоже на дефрагментацию данных
  - Делается редко
- Рядом с файлом таблицы лежит файл VM (visibility map)
  
## Устройство таблиц

- По-умолчанию таблица размером 1 ГБ
- Состоит из страниц по 8 КБ
- Каждая из которых содержит заголовок страницы, строки с их заголовками
- Страница содержит ссылки на строки (CTID)

## VACUUM

- Если вообще не обслуживать БД, то фрагментация будет нарастать
- `VACUUM` - команда для очистки "дохлых" версий строк
- `VACUUM FULL` - полный "компактинг" таблицы
  - Берет эксклюзивную блокировку на запись/чтение таблицы
- Необходим периодический запуск `VACUUM`
- Активно обновляемым БД рекомендуется проходить `VACUUM` каждую ночь
- `VACUUM FULL` только если удалили много данных
- `VACUUM ANALYZE` - комбинация двух операций
- `Autovacuum` - демон, делает всё автоматически.
